{% extends 'base_dashboard.html' %} 
{% load static %}

{% block dashboard_content %}
<link rel="stylesheet" href="{% static 'css/profile_cards.css' %}">

<h1 class="perfil-title">
    Editar Perfil: {{ usuario_base.get_full_name|default:usuario_base.username }}
</h1>

{% if messages %}
<div class="messages-container">
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
    {% endfor %}
</div>
{% endif %}

<div class="perfil-grid-container" style="grid-template-columns: 280px 1fr;">

    <div class="perfil-card card-foto-opcoes">
        <div class="perfil-foto-area">
            <img id="previewFoto"
                 src="{% if usuario_base.foto %}{{ usuario_base.foto.url }}{% else %}{% static 'img/default_user.png' %}{% endif %}"
                 class="perfil-foto">
            <h3>{{ usuario_base.get_full_name|default:usuario_base.username }}</h3>
            <p class="perfil-tipo-usuario">Tipo: **{{ usuario_base.tipo|upper }}**</p>
        </div>

        <div class="perfil-actions-form">
            <h4 class="perfil-section-legend" style="margin-top: 20px;">Status da Conta</h4>
            <form method="POST" action="{% url 'editar_usuario' usuario_base.pk %}">
                {% csrf_token %}
                <div class="perfil-form-group">
                    <label for="{{ perfil_form.is_active.id_for_label }}">Conta Ativa?</label>
                    {{ perfil_form.is_active }}
                    {% if perfil_form.is_active.errors %}<div class="error-message">{{ perfil_form.is_active.errors }}</div>{% endif %}
                </div>
                <input type="hidden" name="action" value="update_status">
                <button type="submit" class="perfil-btn-principal">Atualizar Status</button>
            </form>
            
            <p class="photo-hint" style="margin-top: 20px;">
                ID do Usuário: **#{{ usuario_base.pk }}**<br>
                Último login: {{ usuario_base.last_login|date:"d/m/Y H:i"|default:"Nunca" }}
            </p>
        </div>
    </div>


    <div class="perfil-card card-personal-info">
        <h2 class="perfil-card-title">Informações de Contato e Perfil</h2>
        
        <form method="POST" enctype="multipart/form-data" action="{% url 'editar_usuario' usuario_base.pk %}">
            {% csrf_token %}
            <input type="hidden" name="action" value="update_profile">

            <fieldset class="perfil-form-secao">
                <legend class="perfil-section-legend">Dados de Contato e Acesso</legend>
                
                <div class="perfil-form-row">
                    <div class="perfil-form-group" style="flex: 1 1 100%;">
                        <label for="{{ perfil_form.nome_completo.id_for_label }}">Nome Completo</label>
                        {{ perfil_form.nome_completo }}
                        {% if perfil_form.nome_completo.errors %}<div class="error-message">{{ perfil_form.nome_completo.errors }}</div>{% endif %}
                    </div>
                </div>
                
                <div class="perfil-form-row">
                    <div class="perfil-form-group">
                        <label for="{{ perfil_form.email.id_for_label }}">E-mail</label>
                        {{ perfil_form.email }}
                        {% if perfil_form.email.errors %}<div class="error-message">{{ perfil_form.email.errors }}</div>{% endif %}
                    </div>
                    <div class="perfil-form-group">
                        <label for="{{ perfil_form.telefone.id_for_label }}">Telefone</label>
                        {{ perfil_form.telefone }}
                        {% if perfil_form.telefone.errors %}<div class="error-message">{{ perfil_form.telefone.errors }}</div>{% endif %}
                    </div>
                </div>
                
                <div class="perfil-form-row">
                    <div class="perfil-form-group" style="flex: 1 1 100%;">
                        <label for="{{ perfil_form.endereco.id_for_label }}">Endereço Completo</label>
                        {{ perfil_form.endereco }}
                        {% if perfil_form.endereco.errors %}<div class="error-message">{{ perfil_form.endereco.errors }}</div>{% endif %}
                    </div>
                </div>
            </fieldset>

            {% if medico_form %}
                <fieldset class="perfil-form-secao">
                    <legend class="perfil-section-legend">Dados Profissionais (Médico)</legend>
                    {% for field in medico_form %}
                        <div class="perfil-form-row">
                            <div class="perfil-form-group">
                                <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                                {{ field }}
                                {% if field.errors %}<div class="error-message">{{ field.errors }}</div>{% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </fieldset>
            {% elif paciente_form %}
                <fieldset class="perfil-form-secao">
                    <legend class="perfil-section-legend">Dados do Paciente</legend>
                    {% for field in paciente_form %}
                         <div class="perfil-form-row">
                            <div class="perfil-form-group">
                                <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                                {{ field }}
                                {% if field.errors %}<div class="error-message">{{ field.errors }}</div>{% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </fieldset>
            {% endif %}  

            <div class="actions">
                <button class="perfil-btn-salvar" type="submit">Salvar Alterações</button>
            </div>
        </form>
    </div>

</div>

<style>
.perfil-card input[type="file"] {
    display: none;
}
</style>

{% endblock %}